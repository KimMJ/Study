# 4장 메트릭 게시(Metric Exposition)

* 메트릭 게시
  * 프로메테우스가 메트릭을 이용할 수 있게 만드는 과정
  * HTTP를 통해 수행
  * 주로 메인 함수나 최상위 수준의 함수에서 구현됨.
  * 애플리케이션당 한번만 구성하면 됨.
* 메트릭 게시와는 별개로 프로메테우스 메트릭을 계측할 수 있음.

## Pushgateway

* batch job은 시간 단위나 일 단위 등의 방식으로 정기적인 일정에 따라 수행된다.
  * 지속적으로 동작하지 않기 때문에 이런 작업에 대한 정보를 정확하게 수집할 수 없다.
  * 따라서 pushgateway 가 필요하다.
* pushgateway는 서비스 레벨의 batch job에 대한 metric cache임.
* 각 batch job이 push한 마지막 데이터만 캐싱함.
  * batch job은 종료되기 직전 처리하고 있던 메트릭을 푸시게이트웨이로 푸시함.
  * 프로메테우스는 푸시게이트웨이에 저장된 메트릭 수집.
* batch job은 하나의 머신이나 프로세스 인스턴스에 묶이는 것이 아닌 모든 서비스에 적용됨.
* 기본 포트 9091에서 동작하는 일종의 exporter
  * 프로메테우스가 이를 수집하도록 설정해주어야 함.
* batch job의 지속 시간은 항상 푸시게이트웨이에 반영되고, batch job이 성공한 시간은 푸시게이트웨이로 메트릭의 푸시가 종료된 시간임.
* 푸시게이트웨이에 메트릭을 사용하는 3가지 방법
  * push
    * 이미 생성된 batch job에 대한 메트릭을 삭제하고 푸시된 메트릭  추가.
    * PUT HTTP method
  * pushadd
    * pushgateway에 동일한 이름을 가진 메트릭이 있으면 새로운 값으로 갱신
    * 이미 생성된 다른 이름을 가진 메트릭들은 변경없이 유지됨.
    * POST HTTP method
  * delete
    * batch job과 관련된 메트릭을 모두 삭제
    * DELETE HTTP method

## Bridge

* 프로메테우스 클라이언트 라이브러리는 메트릭을 프로메테우스가 지정한 형식으로만 출력하도록 제한하지 않음.
* 사용자가 원하는 방식으로 메트릭을 처리할 수 있음

## Parser

* 모니터링 시스템을 사용하면 프로메테우스 서버를 동작시키지 않더라도 프로메테우스 생태계가 가진 장점을 활용할 수 있음.

## 메트릭 게시 형식

* 프로메테우스의 텍스트 형태 게시 형식은 생성과 파싱이 쉬움.

### 메트릭 형식

* 일반적인 HELP는 메트릭에 대한 설명으로 수집할 때마다 변경되어서는 안되는 값
* TYPE은 counter, gauge, summary, histogram, untyped 중 하나의 값을 가짐.

### 레이블

* 레이블이 여러개일 경우 쉼표로 구분하고, 닫는 괄호 앞에 쉼표를 붙여도 상관없음.
* 레이블의 순서는 상관이 없지만 일관성을 유지하는 것이 좋음.

### escape character

* 이스케이프 문자에 `\`가 문제될 수 있는 상황이면 `\\`를 사용한다.

### time stamp

* unix epoch시 사용.

### 메트릭 확인

* Promtool은 메트릭 결과가 유효한지를 확인하고 lint 검사를 수행

